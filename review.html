<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>IVG 2026 Review</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
 <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial;
      background: linear-gradient(180deg, #0a3a82, #05224d);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      background: white;
      width: 420px;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    h2 {
      text-align: center;
      color: #0a3a82;
    }

    .info {
      margin: 6px 0;
      font-size: 14px;
    }

    .qr-box {
      text-align: center;
      margin-top: 16px;
    }

    img {
      width: 180px;
      height: 180px;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #2563eb;
      color: white;
    }

    .success {
      background: #dcfce7;
      color: #166534;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 13px;
    }

    .error {
      background: #fde2e2;
      color: #991b1b;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 13px;
    }
  </style>
</head>
<body>

<div class="card">
  <h2>Participant Review</h2>

  <div id="details"></div>

  <div class="qr-box">
    <img id="qrImage" style="display:none;" />
  </div>

  <button onclick="sendQR()">Send QR Code</button>

  <div id="statusMsg"></div>
</div>

<script>
const SUPABASE_URL = "https://eqyfygzpohsnjstnvktj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeWZ5Z3pwb2hzbmpzdG52a3RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5Mjk5NDMsImV4cCI6MjA4NjUwNTk0M30.YtfH9QggE7tFfnOdshEZhvhdVZPKVaBmeLot2KuHGpU";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const params = new URLSearchParams(window.location.search);
const code = params.get("code");

const details = document.getElementById("details");
const qrImage = document.getElementById("qrImage");
const statusMsg = document.getElementById("statusMsg");

let participantData = null;

async function loadParticipant() {

  if (!code) {
    details.innerHTML = `<div class="error">No code provided.</div>`;
    return;
  }

  const { data, error } = await supabase
    .from("participants")
    .select("*")
    .eq("assigned_code", code)
    .single();

  if (error || !data) {
    details.innerHTML = `<div class="error">Participant not found.</div>`;
    return;
  }

  participantData = data;

  details.innerHTML = `
    <div class="info"><b>Code:</b> ${data.assigned_code}</div>
    <div class="info"><b>Name:</b> ${data.full_name}</div>
    <div class="info"><b>Student ID:</b> ${data.student_id}</div>
    <div class="info"><b>Category:</b> ${data.category}</div>
    <div class="info"><b>Email:</b> ${data.email}</div>
  `;

  // Generate QR preview
  const qrURL =
    "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" +
    encodeURIComponent(window.location.origin + "/verify.html?code=" + data.assigned_code);

  qrImage.src = qrURL;
  qrImage.style.display = "block";
}

async function sendQR() {

  if (!participantData) return;

  statusMsg.innerHTML = "";

  const qrLink =
    window.location.origin + "/verify.html?code=" + participantData.assigned_code;

  // Here we just simulate email for now
  // Next step we connect real email service

  const { error } = await supabase
    .from("participants")
    .update({
      qr_sent: true,
      qr_sent_time: new Date()
    })
    .eq("assigned_code", participantData.assigned_code);

  if (error) {
    statusMsg.innerHTML = `<div class="error">${error.message}</div>`;
    return;
  }

  statusMsg.innerHTML = `
    <div class="success">
      QR marked as sent successfully.
      <br><br>
      QR Link:<br>
      ${qrLink}
    </div>
  `;
}

loadParticipant();
</script>

</body>
</html>

